Ext.define("Web.controller.Kapcsolat",{extend:"Ext.app.Controller",stores:["Article","Office","Website"],models:["Article","Website"],views:["kapcsolat.View"],config:{gmaptimeout:100,timeoutCnt:20,panel:null},init:function(){this.control({"contentheadpartial panel[name=contactGMap]":{render:this.onGMapRendered},"contentfooterpartial panel[name=contactContentFooter]":{render:this.onContentFooterRendered},"kapcsolatview button[action=send]":{click:this.onSend}})},onSend:function(e){var c,j,a,h,k,b,i,f="",d="Üzenetét továbbítottuk.",g="Az üzenet továbbítása sikertelen.";j=e.up("fieldset");a=j.down("[name=name]");h=j.down("[name=email]");b=a.validate();i=h.validate();if(i&&b){k=j.down("[name=message]").value;a=a.value;h=h.value;c=new Ext.data.Connection();c.request({method:"POST",url:"Web/classes/server/send.php",params:{name:a,email:h,message:k},success:function(l,m){if(l.responseText==="success"){Ext.Web.Msg.showMsg(d)}else{if(console){console.log(l.responseText)}Ext.Web.Msg.showMsg(g)}},failure:function(l,m){if(l.responseText){if(console){console.log(l.responseText)}}Ext.Web.Msg.showMsg(g)}})}else{f+=(a.activeError)?Ext.String.format("<div>{0}:&nbsp;{1}</div>",a.fieldLabel,a.activeError):"";f+=(h.activeError)?Ext.String.format("<div>{0}:&nbsp;{1}</div>",h.fieldLabel,h.activeError):"";Ext.Web.Msg.showMsg(f)}},onGMapRendered:function(a){if(!this.config.panel){this.config.panel=a}if(!google.maps.MapTypeId&&this.config.gmaptimeout){this.config.gmaptimeout--;setTimeout(Ext.bind(this.onGMapRendered,this),100)}else{if(google.maps.MapTypeId){this.createGMap()}else{if(console){console.log("gmap api loading error!")}}}},createGMap:function(){var b,f,a,d,g,e,c;Ext.DomHelper.append(this.config.panel.body,{tag:"div",id:"map",children:[{tag:"div",id:"map_canvas"}]});b=Ext.Web.Util.findRecord(this.getWebsiteStore(),[{fieldName:"site",value:"Web"},{fieldName:"lang",value:this.getApplication().lang}]);g=b.get("gmapLatLng");if(g){g=g.split(",");e=parseFloat(g[0],10);c=parseFloat(g[1],10);d={zoom:15,mapTypeId:google.maps.MapTypeId.ROADMAP,streetViewControl:true,center:new google.maps.LatLng(e,c)};a=new google.maps.Marker({map:null,draggable:false});f=new google.maps.Map(Ext.get("map_canvas").dom,d);a.setMap(f);a.setPosition(d.center);a.setIcon("img/gmap_marker.png");a.setTitle(b.get("gmaptitle"))}else{if(console){console.log("missing store.Website -> gmapLatLng")}}this.config.panel=null},onContentFooterRendered:function(a){Ext.Web.Util.createArticles(a,this.getArticleStore(),{filterFn:function(b){return/kapcsolat|all/.test(b.get("view"))&&b.get("target")==="content-footer"},itemCallback:[{test:function(b){return/office-contact/.test(b.get("name"))},fn:Ext.bind(this.onOfficeContactRendered,this)}]})},onOfficeContactRendered:function(a){return Ext.Web.Util.createArticles(a,this.getOfficeStore(),{filterFn:function(b){return true},tagArticleContainer:false,clsArticleContainer:false,isArticleItemsAsChildren:true})}});